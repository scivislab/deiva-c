# This is a Spack Environment file.
#
# It describes a set of packages to be installed, along with
# configuration settings.
spack:
  # add package specs to the `specs` list
  packages:
    all:
      target: [haswell]
      providers:
        mpi: [openmpi]
    boost:
      version: ['1.74.0'] # compatibility with older kernels (https://github.com/boostorg/filesystem/issues/173)
    llvm:
      variants: '~compiler-rt~clang~gold~libcxx~lld~lldb~internal_unwind'
    openmpi:
      variants: '+legacylaunchers+pmi+thread_multiple fabrics=ucx schedulers=slurm'
      version: ['4.1.1']
    flex:
      version: ['2.6.4']
    mesa:
      variants: '~glx'
    paraview:
      variants: '+osmesa+python3'
      version: ['5.9.1']
    doxygen:
      version: ['1.8.17']
    fenics:
      variants: '+mpi+scotch+petsc ~hdf5~openmp~parmetisx~petsc4py~slepc~slepc4py~suite-sparse~trilinos'
  specs:
  - fenics
  - paraview

  concretization: together

  container:
    images:
      os: ubuntu:18.04
      spack: latest
    strip: true
    os_packages:
      final:
        - libgfortran4   # required for Fenics' JIT compilation 
        - g++            # required for Fenics' JIT compilation
    extra_instructions:
     final: |
       # link python interpreter
       RUN find /opt/software -path "/opt/software/linux-*/*/python-3.*/bin/python*" -type l -print0 \ 
         | xargs -0i -n 1 ln -fvs '{}' /opt/view/bin
       COPY data /exp/data
       COPY run.py pipeline.py /exp/
       # work in root directory 
       WORKDIR /exp
